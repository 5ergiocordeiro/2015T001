# Histórico
Projeto 2015T001: Relatório de totalizações do Fix32 para a Gerdau

* 14/04/2015
+ Reunião com Michael e Sady
++ Informações e definições preliminares
+++ O Michael já havia montado uma máquina virtual e conseguido comunicar o Fix32 com o Excel via DDE,
+++ Deve ser desenvolvido um aplicativo para aquisição contínua dos dados, totalização e confecção de um relatório.
+++ Discutiram-se alguns detalhes do algoritmo a ser usado.
+++ O aplicativo rodará em Windows XP no servidor, mas será testado no cliente.
+++ A linguagem de programação a ser usada não foi definida.
+++ Pesquisar a melhor maneira de conectar-se ao Fix32 (DDE, OLE, ODBC).
+++ Copiei a máquina virtual para trabalhar
++ Contato por telefone à noite
+++ Negociação do valor a ser pago.
+++ A data de entrega foi combinada: 22/04/2015.
+++ Decidiu-se que o tratamento dos erros será o mais simples possível.
++ **Algoritmo definido:**
+++ Ao partir, verificar se já existe um arquivo para registro das leituras;
+++ Se existir, tentar recuperar os dados; caso contrário, recriar o arquivo;
+++ Ler os dados continuamente;
+++ Registrar no arquivo;
+++ Integrar no tempo;
+++ Ao final do dia, gravar os totais em outro arquivo;
+++ Mudar o arquivo para registro dos valores;
+++ Ao final do mês, gerar o relatório a partir dos totais diários registrados.
+++ Periodicamente, apagar os arquivos temporários.

* 15/04/2015
+ Pesquisa na Internet
++ Descobri que o Fix32 não funciona como servidor ODBC.
++ Não encontrei muita coisa sobre comunicação via OLE.
++ Encontrei informação a respeito de uso de OPC com o Fix32, tendo como cliente o Excel.
++ Encontrei informação a respeito de uso de DDE com o Fix32, tendo como clientes o Excel e o C++.
++ Descobri que há duas tecnologias próprias do Fix32 que podem ser usadas, o EDA (Easy data Access) e o HDC Report, mas não aprofundei a pesquisa.
+ Investigação da máquina virtual
++ O único arquivo de biblioteca de tipos que existe no disco é o OPCDRV.TLB, que corresponde à Intellution OPC Client 7.10 Lybrary.
++ De acordo com a documentação, os arquivos interfacedef.h e interfacedef.obj são necessários para interface do servidor OPC com um cliente C++; esses arquivos não existem no disco.
++ Experimentei a programação da interface com o Fix32 via DDE pelo VBA, sem problemas.
++ Experimentei a programação da interface com o Fix32 via OPC pelo VBA.
+++ Descobri como deve ser o código e esbocei a solução.
+++ Descobri que o OPC Data Access 2.0 Server for iFix (OPC20iFix) não estava instalado na máquina, apesar de aparecer na lista de servidores montada pelo PowerTool.
+++ Descobri que apenas o Intellution OPC Server (OPCEDA) estava instalado na máquina; ele funciona apenas localmente, mas pode ser usado na solução.
+++ Tentei usar o OPCEDA com o PowerTool, mas ele travou durante o browsing.
+++ Consegui usar o OPCEDA com o VBA.
+++ Imagino que na máquina servidora o Workspace estaria disponível, portanto seria possível implementar uma comunicação via OLE Automation, mas não consegui confirmar essa suposição.
++ **Em vista de tudo isso, tracei o caminho a seguir:**
+++ Desenvolver o aplicativo usando DDE e C++;
+++ Desenvolver uma alternativa usando OPC e VBA;
+++ Obter os arquivos que faltam para usar OPC e C++;

* 19/04/2015
+ Iniciei a programação
++ Criei repositório no Github
++ Esbocei a janela para exibição do resultado
++ Comecei a implementar a comunicação via DDE
++ Usei o servidor DDE do Excel para experiências
+++ * Descobri o nome da janela que executa o servidor DDE do Fix32 *
+ Testes
++ Testei a execução do aplicativo na máquina virtual
++ Instalei o GTK+ 3 na máquina virtual
++ * Ajustei os parâmetros para compilação *

* 20/04/2015
+ Prossegui com a programação
++ Descobri diversas coisas:
+++ como obter o handle da janela Windows a partir do GTK
+++ como interceptar o procedimento da janela Windows
+++ como é a convenção para comunicação com o servidor DDE do Excel
+++ como funciona a troca de mensagens com DDE
++ * Consegui ler dados do Excel como servidor DDE *

* 21/04/2015
+ Prossegui com a programação
++ Arrumei o código e fiz mais testes
++ Estão acontecendo coisas inesperadas:
+++ o Excel envia ACK como resposta à mensagem WM_DDE_ADVISE
+++ a aplicação aborta quando leio mais de uma variável
+++ o Excel não envia os dados imediatamente, apenas quando há uma mudança

* 22/04/2015
+ Prossegui com a programação
++ Corrigi o código e fiz mais testes
+++ Ainda estão acontecendo coisas inesperadas:
+++ o Excel envia mesmo ACK como resposta à mensagem WM_DDE_ADVISE
+++ esse ACK deve ser respondido com outro ACK
+++ o formato das mensagens ACK para WM_DDE_ADVISE é diferente daquele para WM_DDE_INITIATE
+++ o Excel não envia mesmo os dados imediatamente, apenas quando há uma mudança
+++ * Consegui fazer o aplicativo obter todos os dados de teste do Excel *
+++ * Consegui fazer o aplicativo obter todos os dados de teste do Fix32 *
++ Implementei o tratamento dos arquivos de dados
++ Implementei o tratamento das fronteiras de tempo
++ Descobri como disparar uma função por tempo
++ * É preciso fazer uma leitura preliminar, com WM_DDE_REQUEST, depois de executar o WM_DDE_ADVISE *

* 23/04/2015
+ Prossegui com a programação
++ Corrigi o código e fiz mais testes
+++ * Fiz uma leitura preliminar com WM_DDE_REQUEST, depois de terminar o WM_DDE_ADVISE *
+++ Quando executo uma leitura, o ADVISE para de funcionar. Não adianta reenviar o ADVISE. É preciso anviar UNADVISE antes.
+++ Havia um erro na função difftime, que contornei.
++ Fiz testes com o Fix32 e parece que tudo está funcionando.
++ * O que falta: *
+++ Passar configurações pela linha de comando
+++ Relatório
+++ Formato do registro gravado
+++ Variáveis do ambiente de produção
+++ Arrumar notebook para levar
+++ Aplicar multiplicadores na integração

* 24/04/2015
+ Conversei com o Michael sobre o formato do relatório.
+ Investiguei a conversão da máquina virtual para Ubuntu:
++ Baixei a ferramenta ovftool da VMware.
+ Investiguei a maneira de tratar os argumentos com o MinGW:
++ A maneira mais completa seria usar a biblioteca argtable, mas neste caso não é conveniente, pois eu teria que instalar mais arquivos na máquina virtual.
++ * Decidi usar a função getopt, nativa. Também existe a função argp_parse, que parece mais complicada.
+ Comecei a implementar a leitura de parâmetros da linha de comando.

* 25/04/2015
+ Investiguei mais a conversão da máquina virtual para Ubuntu:
++ Baixei a ferramenta vdiskmanager da VMware.
++ Uni todos os discos .vdmk em um único.
+ Prossegui com a programação
++ Implementei o uso de multiplicadores na integração

* 26/04/2015
+ Conversei com o Michael sobre alguns detalhes finais.
++ Não consegui descobrir o nome correto das variáveis.
+ Implementei o relatório por meio de uma macro Excel.
+ Implementei a passagem de configurações pela linha de comando, mas não testei suficientemente.
+ Tentei converter a máquina virtual para Ubuntu, sem sucesso.
++ * A conversão foi bem-sucedida, mas o notebook não suporta o KVM. *
+ Tentei instalar o Windows XP no notebook, sem sucesso.
++ Está aparecendo tela azul durante a configuração.
+ Peguei notebook com o Michael.
++ Consegui instalar o GTK e o MinGW e compilar um executável;
+ Acertei o visual da janela para esta revisão, removendo objetos não utilizados.
+ Preparei duas pen-drives para levar.

* 27/04/2015
+ Viajei para Itaguaí
+ Descobri as tags a ler e preparei o arquivo de execução (b.bat)
++ Serão, na verdade, 9 tags, não 8.
++ Decidimos remover a opção de passar os multiplicadores e incluir a de passar nicknames para as variáveis.
+ Testei o programa
++ A comunicação funcionou corretamente
++ Acontece um erro na integração porque o Fix32 está enviando dados em português (com ponto de milhar).
++ O servidor DDE não parte automaticamente após o DDE_INITIATE.
+ Decidimos melhorar o código:
++ Incluir opção no menu para chamar o relatório Excel.
++ Criar um arquivo .bat para partir o servidor DDE e depois partir o programa.
++ Recuperar os totais na partida do programa
+ Implementei as correções no programa:
++ Limpei o ponto de milhar no recebimento
++ Incluí a nova tag
++ Implementei a opção nova no lugar da antiga
++ Criei o atalho no menu.
++ Implementei a recuperação da totalização na partida.
+ Instalei e testei o programa
++ Na partida, o programa reclama da falta da DLL libwinpthread-1.dll


* 28/04/2015
+ O programa parou de compilar após algumas alterações no código e no ambiente.
++ * Descobri que o programa de instalação do MinGW não é muito bom. *
++ * Descobri que as variáveis de ambiente devem ser documentadas. *
++ Consegui resolver o problema.
+ Melhorei o programa:
++ Implementei o verbose.
++ Diminuí o tamanho da janela.
++ Implementei as opções z.
++ Acertei o número de casas decimais e a formatação do resultado.
+ Investiguei o problema com a DLL libwinpthread-1:
++ Descobri que não existe uma bibliotec estática libwinpthread-1.a.
++ Linkei as bibliotecas estáticas libpthread.a e libwinpthread.a, sem sucesso.
++ Copiei a DLL para o computador destino para contornar o problema.
+ Testei as alterações
++ Quando o programa lê a configuração da linha de comando, ele tem problemas na alocação de memória. Coloquei a configuração no código (default).
++ A conversão de datas estava errada, causando crash do programa. Corrigi o problema.
++ Corrigi o tamanho da janela e a formatação dos dados.
++ O arquivo .bat trava ao partir o DDE. Fiz com que o próprio programa partisse o servidor.
++ Corrigi a recuperação de dados dos arquivos.
++ Corrigi o tratamento das fronteiras de tempo.
+ * Pendências: *
++ Resolver o problema com a DLL libwinpthread-1.
++ Fazer com que o programa rode como serviço.
++ Fazer com que o programa reinicialize a conexão após algum erro ou interrupção.
++ Fazer com que o programa leia a configuração de um arquivo, não da linha de comando.
++ Incluir testes contra falha na alocação de memória. 

* 29/04/2015
+ Trabalhei no relatório
+ * Implementei a reinicialização da conexão após longa inatividade. *
+ * Implementei o bloqueio de criação de instâncias repetidas. *
+ Testei o programa e a planilha, com sucesso.
++ Configurei o agendamento de tarefas e o PATH do Windows.
++ Criamos um botão para chamada do relatório a partir do Fix32 (tela excel.odf)

* 30/04/2015
+ Escrevi o descritivo para configuração de uma máquina backup
+ Criei e testei o arquivo techsteel.ico.
+ * Pendências: *
++ Resolver o problema com a DLL libwinpthread-1.
++ Fazer com que o programa rode como serviço.
++ Fazer com que o programa leia a configuração de um arquivo, não da linha de comando.
++ Incluir testes contra falha na alocação de memória. 

04/05/2015
+ Trabalho nas novas demandas:
++ Relatório diário, não mensal (feito).
++ Colocar unidades na tela.
++ Fazer a planilha ficar mais robusta.
++ Trocar Última leitura por Atual.

09/05/2015
+ Desinstalei o VMware Player e o OVF.
+ Finalização do relatório (diário e mensal na mesma planilha).

12/05/2015
+ Preparei a documentação para o usuário final.
++ Falta obter imagens de telas em inglês
++ Falta obter o arquivo excel.odf.

02 e 03/06/2015
+ Consertei erro na macro do Excel para geração do relatório mensal.
+ Alterei o programa de coleta de dados:
++ Dar preferência para leitura do arquivo horário na partida.
++ Trocar Última leitura por Atual.
++ Colocar unidades na tela.
+ Enviei os arquivos ao Sady.



Notebook de desenvolvimento:
Variáveis de ambiente em 28/04/2015
PATH: (user)
C:\Program Files\gtk-3.8.1;c:\gtk\bin;C:\Program Files\mingw-w64\i686-4.9.2-posix-dwarf-rt_v4-rev2\mingw32\bin;C:\Program Files\mingw-w64\i686-4.9.2-posix-dwarf-rt_v4-rev2\mingw32\libexec\gcc\i686-w64-mingw32\4.9.2;c:\gtk\lib

PATH: (system)
%SystemRoot%\system32;%SystemRoot%;%SystemRoot%\System32\Wbem;%SYSTEMROOT%\System32\WindowsPowerShell\v1.0\


Compilação: c.bat



Desktop de desenvolvimento:
Compilação: b.bat
